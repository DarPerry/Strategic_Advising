<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>

    <link type="text/css" rel="stylesheet" href="stylesheets/output-stylesheet.css">

    <link rel="shortcut icon" href="images/favicon.ico">
    <meta charset="UTF-8">

    <title>Strategic Advising</title>
    <script>
        function emailTo() {

            $.ajax({
                url: "../students/" + sessionStorage.getItem("newStudentId") + ".sa",
                success: function(data) {
                    sessionStorage.setItem("studentInformation", data);
                },
                async: false // <- this turns it into synchronous
            });

            var studentObject = sessionStorage.getItem("studentInformation");
            var studentInfo = JSON.parse(studentObject);



            var input = document.getElementById('email');
            email = studentInfo.student_email;
            var input = document.getElementById('subject');
            subject = window.prompt("Email Subject:");

            window.location.href = "mailto:" + email + "?subject=" + subject;
        }


        var tablesToExcel = (function() {
            var uri = 'data:application/vnd.ms-excel;base64,',
                template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>',
                templateend = '</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>',
                body = '<body>',
                tablevar = '<table>{table',
                tablevarend = '}</table>',
                bodyend = '</body></html>',
                worksheet = '<x:ExcelWorksheet><x:Name>',
                worksheetend = '</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>',
                worksheetvar = '{worksheet',
                worksheetvarend = '}',
                base64 = function(s) {
                    return window.btoa(unescape(encodeURIComponent(s)))
                },
                format = function(s, c) {
                    return s.replace(/{(\w+)}/g, function(m, p) {
                        return c[p];
                    })
                },
                wstemplate = '',
                tabletemplate = '';

            return function(table, name, filename) {
                var tables = table;

                for (var i = 0; i < tables.length; ++i) {
                    wstemplate += worksheet + worksheetvar + i + worksheetvarend + worksheetend;
                    tabletemplate += tablevar + i + tablevarend;
                }

                var allTemplate = template + wstemplate + templateend;
                var allWorksheet = body + tabletemplate + bodyend;
                var allOfIt = allTemplate + allWorksheet;

                var ctx = {};
                for (var j = 0; j < tables.length; ++j) {
                    ctx['worksheet' + j] = name[j];
                }

                for (var k = 0; k < tables.length; ++k) {
                    var exceltable;
                    if (!tables[k].nodeType) exceltable = document.getElementById(tables[k]);
                    ctx['table' + k] = exceltable.innerHTML;
                }

                //document.getElementById("dlink").href = uri + base64(format(template, ctx));
                //document.getElementById("dlink").download = filename;
                //document.getElementById("dlink").click();

                window.location.href = uri + base64(format(allOfIt, ctx));

            }
        })();
        $(document).ready(function() {

            var sessionStudentInformation = sessionStorage.getItem("studentInformation");
            var parsedStudentInformation = JSON.parse(sessionStudentInformation);





            if (parsedStudentInformation.schedule.length != 0) {
                var tableString = "";
                var yearInt = 1;
                var studentStanding = "";









                parsedStudentInformation.schedule.forEach(function(e) {
                    if (yearInt == 1) {
                        studentStanding = "Freshman";
                    } else if (yearInt == 2) {
                        studentStanding = "Sophmore";
                    } else if (yearInt == 3) {
                        studentStanding = "Junior";
                    } else if (yearInt == 4) {
                        studentStanding = "Senior";
                    }
                    tableString += "<div id='year" + yearInt + "' class='yearPlan'><h2>" + studentStanding + "</h2>"
                    yearInt++;
                    e.year.forEach(function(f) {
                        tableString += "<table><thead><tr><th>Course Number</th><th>Course Title</th><th>Credits</th></tr></thead><tbody id='droppable'><tr>"
                        f.forEach(function(g) {
                            tableString += "<td class='number'>" + g + "</td><td class='title'></td><td class='credits'></td></tr>"
                        })
                        tableString += "</tbody><tfoot><tr><td colspan='2'>Total Credits:</td><td id='totalCredits'></td></tr></tfoot></table>";
                    })
                    tableString += "</div>"
                })
            } else {
                //fix way of doing this
                tableString = ' <div class="yearPlan" id="year1"> <h2>Freshman Year</h2> <table id="myTable" > <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS120</td> <td>Computer Science 1</td> <td class="credits">4</td> </tr> <tr> <td class="number">MATH161/165</td> <td>Math Course 1</td> <td class="credits">3</td> <!-- Math 165 is 4 credits--> </tr> <tr> <td class="number">ENG103</td> <td>Rhetoric and Writing</td> <td class="credits">3</td> </tr> <tr> <td class="number">SCI</td> <td>Tier 1 Natural Science</td> <td class="credits">3</td> </tr> <tr> <td class="number">PFW</td> <td>Wellness Course</td> <td class="credits">3</td> </tr> </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS121</td> <td>Computer Science 2</td> <td class="credits">4</td> </tr> <tr> <td class="number">MATH/162/166</td> <td>Math Course 2</td> <td class="credits">3 or 4</td> </tr> <tr> <td class="number">CS124</td> <td>Discrete Structures</td> <td class="credits">3</td> </tr> <tr> <td class="number">FIN101</td> <td> Personal Finance for Fiscal Wellness</td> <td class="credits">1</td> </tr> <tr> <td class="number">ENG104</td> <td>Composing Research </td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table>  </div> <div class="yearPlan" id="year2"> <h2>Sophmore Year</h2> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS222</td> <td>Advanced Programming</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS230</td> <td>Computer Organization and Architecture</td> <td class="credits">3</td> </tr> <tr> <td class="number">UCC</td> <td>Tier 1 Social Science</td> <td class="credits">3</td> </tr> <tr> <td class="number">SCI</td> <td>Tier 1 Natural Science</td> <td class="credits">3</td> </tr> <tr> <td class="number">TBD</td> <td>MATH221 or ECON 221</td> <td class="credits">3</td> </tr> <tr> <td class="number">COMM210</td> <td>Fundamentals of Public Speaking</td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS 200</td> <td>Computers and Society</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS239</td> <td>Social and Professional Issues</td> <td class="credits">3 or 4</td> </tr> <tr> <td class="number">CS324</td> <td>Design and Analysis of Algorithms</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS</td> <td> CS Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">UCC</td> <td>T1 H</td> <td class="credits">3</td> </tr> <tr> <td class="number">UCC</td> <td>T1 Fine Arts</td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> </div> <div class="yearPlan" id="year3"> <h2>Junior Year</h2> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS335</td> <td>Programming Languages </td> <td class="credits">3</td> </tr> <tr> <td class="number">CS376</td> <td>Operating Systems </td> <td class="credits">3</td> </tr> <tr> <td class="number">CS380</td> <td>Theory of Computation</td> <td class="credits">3</td> </tr> <tr> <td class="number">UCC</td> <td>Tier 2 Non-Natural Science</td> <td class="credits">3</td> </tr> <tr> <td class="number">HIST150</td> <td>The West in the World</td> <td class="credits">3</td> </tr> <tr> <td class="number">WPP392</td> <td>Writing Proficiency Exam</td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS327</td> <td>Computers and Society</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS436</td> <td> Distributed Processing and Networks</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS</td> <td>CS Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS</td> <td>CS Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> </div> <div class="yearPlan" id="year4"> <h2>Senior Year</h2> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS495</td> <td>Software Engineering 1</td> <td class="credits">3</td> </tr> <tr> <td class="number">CS</td> <td>CS Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> <table> <thead> <tr> <th>Course Number</th> <th>Course Title</th> <th>Credits</th> </tr> </thead> <tbody id="droppable"> <tr> <td class="number">CS498</td> <td>Software Engineering 2</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr> <tr> <td class="number">GEN</td> <td>General Elective</td> <td class="credits">3</td> </tr>  </tbody> <tfoot> <tr> <td colspan="2">Total Credits:</td> <td id="totalCredits">0</td> </tr> </tfoot> </table> </div>';
            }
            $("#container").append(tableString)

            //--------------------------------------------------------------------------------------//
            $.ajax({
                url: "../course_plans/computerScience.cpl",
                success: function(data) {
                    var catalogData = JSON.parse(data)
                    $(".number").each(function(a) {
                        console.log($(".number").eq(a).html())
                        catalogData.forEach(function(x) {
                            console.log(x.number)
                            if ($(".number").eq(a).html() == x.number) {
                                console.log("*--HIT--*")
                                $(".number").eq(a).parent().find(".credits").html(x.credits)
                                $(".number").eq(a).parent().find(".title").html(x.name)
                            }
                        })

                    })
                },
            });
            $(".number").each(function(scheduledCourse) {
                parsedStudentInformation.courses_taken.forEach(function(courseTaken) {
                    if ($(".number").eq(scheduledCourse).html() == courseTaken.split("_").join("")) {
                        $(".number").eq(scheduledCourse).parent().remove()
                    }
                })


            })







            $("#save").click(function() {
                var studentSchedule = new Array();
                var studentObject = sessionStorage.getItem("studentInformation");
                var studentInfo = JSON.parse(studentObject);

                var semester = new Array();
                var year = new Array();

                $(".yearPlan").each(function() {
                    $(this).find("table").each(function(e) {
                        $(this).find(".number").each(function(f) {
                            semester.push('"' + $(this).html() + '"');
                        })
                        year.push("[" + semester + "]");
                        semester = new Array()

                    })
                    studentSchedule.push(' {"year": [' + year + ']}');
                    year = new Array()
                })



                var student =
                    '{"student_name": "' + studentInfo.student_name +
                    '", "student_email": "' + studentInfo.student_email +
                    '", "id_number" : ' + studentInfo.id_number +
                    ', "expected_graduation": "' + studentInfo.expected_graduation +
                    '", "major": "' + studentInfo.major +
                    '", "concentration": "' + studentInfo.concentration +
                    '", "courses_taken": ["' + studentInfo.courses_taken.join('", "') +
                    '"],  "summer_classes": "' + studentInfo.summer_classes +
                    '", "early_graduation": "' + studentInfo.early_graduation +
                    '", "honors_college": "' + studentInfo.honors_college +
                    '", "min_credits": ' + studentInfo.min_credits +
                    ', "max_credits":  ' + studentInfo.max_credits +
                    ', "schedule": [' + studentSchedule + "]}";

                $.ajax({
                    url: "modifyStudent.php",
                    data: {
                        student_info: student,
                        student_id: studentInfo.id_number
                    },
                    success: function(data) {
                        window.alert(data)
                    }
                })

                sessionStorage.setItem("studentInformation", student)


            })



            $("#mail").attr("href", "mailto:hello")


            $("#btnExport").click(function(e) {

                fnExcelReport()

            });

            var studentObject = sessionStorage.getItem("studentInformation");
            var studentInfo = JSON.parse(studentObject);
            var minimumCredits = studentInfo.min_credits;
            var maximumCredits = studentInfo.max_credits;
            var studentSchedule = studentInfo.schedule;


            //--
            var total = 0;
            $("tbody").each(function() {
                $(this).find(".credits").each(function() {
                    total += parseInt($(this).html());
                });
                $(this).parent().find("#totalCredits").html(total);
                total = 0;

            });
            //--

            $("#add").click(function() {

                $("#container").toggleClass("blurred");
                $("#addTable").append("<tr id='draggable'><td><input type='text' style='width:50px' class='inputInfo'></td><td><td><input type='text' class='inputInfo'></td><td><td class='credits'><input type='text' style='width:15px' class='inputInfo'></td></tr>");
                $("#draggable").draggable();

            });

            $("#edit").on("keyup", '.inputInfo', function(event) {
                if (event.keyCode === 13) {
                    var inputs = $("input[type='text']")
                    $("#addTable").find("#draggable").html("<td>" + inputs.eq(0).val() + "</td><td>" + inputs.eq(1).val() + "</td><td class='credits'>" + inputs.eq(2).val() + "</td>");
                    $("#container").toggleClass("blurred");
                    $("#draggable").draggable();


                }
            });

            $("#delete").droppable({
                drop: function(event, ui) {
                    $("#draggable").remove();

                }
            })



            $(".tab").click(function() {
                window.location.href = "search-page.html";
            });

            $("tbody").on('mousedown', 'tr', function() {
                $(this).attr("id", "draggable");
                $("#draggable").draggable();


            });

            $("tbody").on('click', 'tr', function() {
                $(this).addClass("dragging");
            });

            $("tbody").droppable({

                drop: function(event, ui) {

                    $(this).append("<tr>" + $("#draggable").html() + "</tr>");
                    $("#draggable").remove();

                    var total = 0;
                    $("tbody").each(function() {
                        $(this).find(".credits").each(function() {
                            total += parseInt($(this).html());
                        });
                        $(this).parent().find("#totalCredits").html(total);
                        total = 0;

                        if ($(this).parent().find("#totalCredits").html() < minimumCredits || $(this).parent().find("#totalCredits").html() > maximumCredits) {
                            $(this).parent().find("#totalCredits").addClass("caution");
                        } else {
                            $(this).parent().find("#totalCredits").removeClass("caution");
                        }

                    });
                }
            })
        });

    </script>


</head>

<body>


    <div id="header">

        <div class="tab">Search Student</div>
    </div>
    <div id="edit">
        <img src="images/add.png" id="add" />
        <table id="addTable"></table>
        <img src="images/delete.png" id="delete" />
        <img src="images/save.png" id="save" />
        <img src="images/export.png" id="export" onclick="tablesToExcel(['year1', 'year2', 'year3', 'year4'], ['first', 'second', 'third', 'fourth'], 'myfile.xls')" />
        <img src="images/email.png" id="mail" onclick="emailTo()" />
    </div>
    <div id="container">

    </div>
    <div id="footer">

    </div>
</body>

</html>
